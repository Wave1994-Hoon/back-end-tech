# DB 커넥션 풀
## 1. 사용 목적
- (1) DB 와 네트워크 연결하는 시간 단축
    - 응답시간 단축 -> 처리량 증가
    
- (2) DB 에 대한 커넥션 개수를 일정 수준으로 제한
    - DB 포화 방지 -> 일관된 DB 성능 유지
    

## 2. 풀 설정과 성능
- 올바르게 설정하지 않으면 오히려 성능 문제 유발
- 설정이 성능에 주는 영향을 알아야 함
- 스프링 부트의 기본 커넥션 풀인 Hikari 기준으로 설명

## 3. maximumPoolSize
- 최대 커넥션 개수
    - 풀이 제공할 수 있는 최대 커넥션 개수
    - 사용 중 + 유휴 커넥션
    
- 계산에 필요한 항목
    - 한 커넥션 당 쿼리 실행 시간, 최대(목표) TPS
    
- 단순 계산 식
    - 최대 TPS = 1개 커넥션의 초당 커리 요청 개수 X 동시 커넥션 개수
    - 동시 커넥션 개수 = 최대 TPS / 1개 커넥션의 초당 요청 처리 개수 = 최대 TPS / (1초 / 쿼리 실행 시)
    
- 최대 개수 고려 사항
    - 느린 쿼리를 염두하고 최대 개수를 높여야 한다.
    - 평균 이상으로 실행 시긴이 튀는 개수나 비율 검토
        - 0.1 초가 평균인데 1초 걸리는 쿼리가 순간적으로 5개가 발생한다면 ?
        - 커넥션 풀 최대 개수 10개일 때 TPS 는 100 -> 55 로 떨어짐 
            - 1초/1초 X 5개 요청 = 5 TPS
            - 1초/0.1초 X 5개 요청 = 50 TPS
    
## 4. connectionTimeout
- 풀에서 커넥션을 구하기 위해 대기하는 시간
    - 풀의 모든 커넥션이 사용중일 때 대기 발생
    
- 고려 사항
    - 기본 값은 너무 크다: 디폴트 30초
        - 순간적인 트래픽 증가 시 쓰레드풀 기반 WAS 는 모든 쓰레드가 대기할 수 있음
        - 사용자는 응답 없는 상태 지속 
    - 기본 값 대신에 0.5 ~ 3초 이내로 설정
        - 응답 없는 것 보다는 빨리 에러 화면이라도 응답주는게 낫다.

## 5. maxLifetime
- 커넥션 최대 유지 시간
    - 커넥션을 생성한 이후 이 사간이 지나면 커넥션을 닫고 풀에서 제거
    - 제거한 뒤 커넥션을 새로 생성
    
- 기본 규칙
    - 네트워크나 DB의 관련 설정 값보다 작은 값 사용
    - 예: 네트워크 장비의 최대 TCP 커넥션 유지 시간

- 이 값이 관련 설정보다 크면
    - 이미 유효하지 않은 커넥션이 풀에 남게 됨
    - 풀에서 유효하지 않은 커넥션을 구하는 과정에서 커넥션을 새로 생성
    - 트래팩이 몰리는 시점을 경우 성능 저하 유발 

## 6. keepaliveTIme
- 커넥션이 살아 있는지 확인하는 주기
    - 유휴 커넥션에 대해 커넥션 확인
    - 유효하지 않은 커넥션은 풀에서 제거
    - 제거한 뒤 커넥션을 새로 생성  
- 기본 규칙
    - 네트워크나 DB 관련 설정 값보다 작은 값 사용
    - 예: DB 의 미활동 커넥션 대기 시간

## 7. minimumIdle
- 풀에 유지할 최소 유휴 커넥션 개수
    - 설정하지 않으면 maximumPoolSize 와 동일
- 기본 규칙
    - Hikari 문서: 설정하지 않는 것 추천
        - 즉 maximumPoolSize 와 동일 크기 추천 -> 고정 크기 풀 추천
        - 이 값이 작으면 급격한 트래픽 증가 시 성능 저하 일으킬 가능성 있음
    
    - 설정할 경우 다음 고려
        - 트래팩이 서서히 증가 -> 최소 시점 TPS 기준
        - 트래픽이 특정 시점에 급격히 증가 -> 설정하지 말 것 
    
- 트래픽 적은 시간대 DB 자원 사용 줄이기 위함

## 8. idleTimeout
- 사용되지 않고 풀에 머무를 수 있는 시간
    - 풀에서 이 시간동안 머무른 커넥션은 종료하고 풀에서 제거
    - minimumIdle < maximumPoolSize 인 경우에 적용
    - 이 시간이 지났다고 바로 빠지진 않음 (문서: 15초 + )
- 기본 규칙
    - 트래픽이 빠지는 간격

## 출처
- https://www.youtube.com/watch?v=6Q7iRTb4tQE