# 카프카 산전수전 노하우
## 참고링크
https://tv.kakao.com/channel/3150758/cliplink/391419257

## 1. 카프카 현황
### 용어 정리
![image](https://user-images.githubusercontent.com/60383031/156765389-f5e49a4d-9137-438e-a696-b9d2887bcd9d.png)

- 프로듀서: 카프카로 메시지를 보냄
- 컨슈머: 카프카에 저장된 데이터를 가져옴
- 카프카: 프로듀서가 보낸 데이터를 저장
- 주키퍼: 분산 코디네이터 시스템 -> 메타데이터 관리, 클러스터 노드 관리

<br>

### 클러스터를 운영한다면 ??
![image](https://user-images.githubusercontent.com/60383031/156765644-651b520f-de03-4da4-a4cd-4675678c2487.png)

- 주키퍼는 쿼럼 방식을 사용하기 때문에 노드 개수는 홀수를 유지해야 한다. (최소 수량 3대)
- 카프카는 리플리케이션 방식이 쿼럼은 아니지만 최소 3대를 유지하는 경우가 일반적이다.

<br>

### 인프라 운영
![image](https://user-images.githubusercontent.com/60383031/156766203-6e4a617e-7298-4bc1-ad6b-fe3beb8e28d0.png) 

- 각 IDC 마다 주키퍼 세트와 카프카 클라스터를 둔다.

<br>

## 2. 트러블 슈팅
### Shrinking ISR
![image](https://user-images.githubusercontent.com/60383031/156766641-fe648e53-d060-44c4-8af4-1dafaa356ef9.png)

- 리플리케이션이기 때문에 분류 -> 리더 / 팔로워
- 리더: 읽고 쓰기
- 팔로워: 리더랑 주기적으로 동기화
- ISR 구성원만이 리더의 자격을 가지게 된다.

![image](https://user-images.githubusercontent.com/60383031/156766973-a11c510b-8c01-43a6-9494-fa354f753dfa.png)

- 위 그림은 Broker 1 번이 문제가 생김

![image](https://user-images.githubusercontent.com/60383031/156767023-373badf0-1e8e-4034-89dd-6264f3215b50.png)

- ISR 내에 다른 브로커가 리더가 됨
- ISR 이 축소됨, 이를 Shrinking ISR 이라고 부른다.

<br>

![image](https://user-images.githubusercontent.com/60383031/156767924-c106d241-011b-40cc-b337-6d41864273e4.png)


- 카프카의 로그 타입 INFO, Waring, Error 

<br>

![image](https://user-images.githubusercontent.com/60383031/156767997-a030a628-ca03-4805-8e2e-59ba4b04faeb.png)


- 브로커 5번이 모든 ISR 을 축소하는 현상 ??
- 파티션에 대하여 리더를 가져가 버림 -> 리플리케이션이 안됨
- 이 버그는 픽스가 되어있느 상황

<br>

### 카프카 버전 업그레이드
![image](https://user-images.githubusercontent.com/60383031/156768303-a1d6bfd5-a22f-4d2e-93fb-38db42102c0b.png)

- 대부분의 시스템은 다운타임은 허용하지 않으니 한대씩 ...

<br>

### Rack Power
![image](https://user-images.githubusercontent.com/60383031/156768720-e47779f6-93cc-41b1-8819-9e6b892b418b.png)

- RACK 1 번이 문제가 생기면 클러스터 전체가 다운

![image](https://user-images.githubusercontent.com/60383031/156768807-9e5273f9-c6c2-42b1-81f3-26c4ee922f0f.png)

- 골고루 배치해야함

<br>

## 3. 프로듀서와 컨슈머
### 프로듀서
![image](https://user-images.githubusercontent.com/60383031/156770148-b888d5dd-c105-41ac-a20a-654e936a5c1f.png)

![image](https://user-images.githubusercontent.com/60383031/156770210-83bc2972-420d-4167-8645-f65406766825.png)

- 메시지 손실과 직접적인 관련이 있는 옵션이기 때문에 프로듀서에서 설정할 수 있는 중요한 옵션이디ㅏ.

<br>

![image](https://user-images.githubusercontent.com/60383031/156770539-e9c37487-f8a1-4585-af44-10c90e6e3277.png)

- ack 1 을 프로듀서에게 보내고 리더는 리플리케이션을 한다.  
- 리플리케이션을 할 때, 장애가 발생하면 팔로워 중 한명이 리더역할을 하기 때문에 메시지가 유실될 수 있다.
- ack = all 옵션을 주면 손실 없이 운영이 가능하다.

<br>

![image](https://user-images.githubusercontent.com/60383031/156779973-cd92aa8b-bec9-4b71-8046-38a98e975d27.png)

- 키 값이 없다면 라운드로빈 방식으로 균등하게 분배한다.

<br>

### 컨슈머

![image](https://user-images.githubusercontent.com/60383031/156780246-a960ba8d-140f-4aa7-a568-65c435007667.png)

- 컨슈머가 poll 하는 방식, 컨슈머의 리소스를 사용

<br>

![image](https://user-images.githubusercontent.com/60383031/156780465-8b64feb1-ead0-4ec3-bbd9-ec3bb036125c.png)

- 컨슈머는 파티션 번호는 관여하지 않고, 각 피티션의 오프셋으로만 접근
- 여러 파티션을 사용한다면 메시지 순서가 꼬일 수 있음, 메시지의 특정 필드에 타임스탬프 값을 넣어 순서를 정렬하는 방식으로 해결 가능

<br>

![image](https://user-images.githubusercontent.com/60383031/156780963-a132e239-743d-403b-9916-5d2a39331723.png)

- 하나의 파티션에는 하나의 컨슈머만 가능

<br>

![image](https://user-images.githubusercontent.com/60383031/156781633-3e1e68a5-488e-4b0f-8e03-68871da6ad49.png)

- 미들웨어에 따라 컨슈머 그룹을 나눌 수 있음

<br>

### Lag
![image](https://user-images.githubusercontent.com/60383031/156781792-6bd0a1e4-95a0-481e-9dec-56877f859236.png)

- 컨슈머가 알마나 밀리지 않고 가져가고 있는가

<br>

## 4. 운영
### 미사용 토픽
![image](https://user-images.githubusercontent.com/60383031/156782981-a60e7a73-5337-460d-a6c2-27af67a90e88.png)

- JMX 로 처리

